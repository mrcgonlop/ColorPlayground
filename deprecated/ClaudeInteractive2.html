<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Film Emulation System - DaVinci Wide Gamut</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 2000px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #fff;
            font-size: 28px;
        }
        
        .subtitle {
            text-align: center;
            margin-bottom: 30px;
            color: #888;
            font-size: 14px;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 420px 1fr 300px;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .controls-panel {
            background: #252525;
            border-radius: 8px;
            padding: 20px;
            height: fit-content;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            position: sticky;
            top: 20px;
        }
        
        .controls-panel::-webkit-scrollbar {
            width: 8px;
        }
        
        .controls-panel::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 4px;
        }
        
        .controls-panel::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }
        
        .visualization-panel {
            background: #252525;
            border-radius: 8px;
            padding: 20px;
        }
        
        .scope-panel {
            background: #252525;
            border-radius: 8px;
            padding: 20px;
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        
        .preset-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .preset-btn {
            padding: 12px;
            background: #333;
            border: 2px solid #444;
            border-radius: 6px;
            color: #e0e0e0;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            font-weight: 500;
        }
        
        .preset-btn:hover {
            background: #3a3a3a;
            border-color: #666;
        }
        
        .preset-btn.active {
            background: #0066cc;
            border-color: #0077ee;
            color: white;
        }
        
        .curve-editor {
            margin-bottom: 20px;
        }
        
        .curve-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .curve-title {
            font-size: 13px;
            font-weight: 600;
            color: #fff;
        }
        
        .curve-canvas {
            width: 100%;
            height: 100px;
            background: #1a1a1a;
            border-radius: 6px;
            cursor: crosshair;
            border: 1px solid #333;
        }
        
        .global-controls {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #333;
        }
        
        .slider-group {
            margin-bottom: 15px;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #333;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #0066cc;
            cursor: pointer;
        }
        
        .slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #0066cc;
            cursor: pointer;
            border: none;
        }
        
        .test-images {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .image-pair {
            background: #1a1a1a;
            border-radius: 6px;
            padding: 10px;
        }
        
        .image-label {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #aaa;
            text-align: center;
        }
        
        .image-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .test-image {
            width: 100%;
            height: auto;
            border-radius: 4px;
        }
        
        .image-subtitle {
            font-size: 11px;
            color: #666;
            text-align: center;
            margin-top: 5px;
        }
        
        .reset-btn {
            width: 100%;
            padding: 10px;
            background: #444;
            border: none;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            margin-top: 15px;
        }
        
        .reset-btn:hover {
            background: #555;
        }
        
        .point-indicator {
            font-size: 10px;
            color: #666;
            margin-top: 5px;
        }
        
        .section-header {
            font-size: 15px;
            font-weight: 600;
            color: #fff;
            margin: 20px 0 12px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid #333;
        }
        
        .crosstalk-matrix {
            display: grid;
            grid-template-columns: auto repeat(3, 1fr);
            gap: 8px;
            margin-top: 10px;
            font-size: 11px;
        }
        
        .matrix-label {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #aaa;
        }
        
        .matrix-input {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 6px;
            color: #fff;
            text-align: center;
            font-size: 11px;
            width: 100%;
        }
        
        .matrix-input:focus {
            outline: none;
            border-color: #0066cc;
        }
        
        .vectorscope-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1;
        }
        
        .vectorscope {
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            border-radius: 8px;
            border: 1px solid #333;
        }
        
        .scope-label {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #fff;
            text-align: center;
        }
        
        .scope-legend {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
            font-size: 11px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            border: 1px solid #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Complete Film Emulation System</h1>
        <p class="subtitle">Full parametric control • Channel crosstalk • Real-time vectorscope • Click curves to edit</p>
        
        <div class="main-grid">
            <!-- Controls Panel -->
            <div class="controls-panel">
                <h3 style="margin-bottom: 15px; font-size: 16px;">Film Presets</h3>
                <div class="preset-buttons">
                    <button class="preset-btn" onclick="loadPreset('neutral')">Neutral</button>
                    <button class="preset-btn" onclick="loadPreset('velvia')">Fuji Velvia</button>
                    <button class="preset-btn" onclick="loadPreset('portra')">Kodak Portra</button>
                    <button class="preset-btn" onclick="loadPreset('cinestill')">Cinestill 800T</button>
                    <button class="preset-btn" onclick="loadPreset('teal_orange')">Teal & Orange</button>
                    <button class="preset-btn" onclick="loadPreset('agfa')">Agfa Vista</button>
                </div>
                
                <div class="section-header">Hue Transforms</div>
                
                <div class="curve-editor">
                    <div class="curve-header">
                        <span class="curve-title">Hue → Hue Shift</span>
                    </div>
                    <canvas id="hueVsHueCanvas" class="curve-canvas" width="380" height="100"></canvas>
                    <div class="point-indicator" id="hueVsHueInfo">Click to add points</div>
                </div>
                
                <div class="curve-editor">
                    <div class="curve-header">
                        <span class="curve-title">Hue → Saturation</span>
                    </div>
                    <canvas id="hueVsSatCanvas" class="curve-canvas" width="380" height="100"></canvas>
                    <div class="point-indicator" id="hueVsSatInfo">Click to add points</div>
                </div>
                
                <div class="curve-editor">
                    <div class="curve-header">
                        <span class="curve-title">Hue → Luminance</span>
                    </div>
                    <canvas id="hueVsLumCanvas" class="curve-canvas" width="380" height="100"></canvas>
                    <div class="point-indicator" id="hueVsLumInfo">Click to add points</div>
                </div>
                
                <div class="section-header">Saturation Transforms</div>
                
                <div class="curve-editor">
                    <div class="curve-header">
                        <span class="curve-title">Saturation → Saturation</span>
                    </div>
                    <canvas id="satVsSatCanvas" class="curve-canvas" width="380" height="100"></canvas>
                    <div class="point-indicator" id="satVsSatInfo">Click to add points</div>
                </div>
                
                <div class="section-header">Luminance Transforms</div>
                
                <div class="curve-editor">
                    <div class="curve-header">
                        <span class="curve-title">Luminance → Saturation</span>
                    </div>
                    <canvas id="lumVsSatCanvas" class="curve-canvas" width="380" height="100"></canvas>
                    <div class="point-indicator" id="lumVsSatInfo">Click to add points</div>
                </div>
                
                <div class="curve-editor">
                    <div class="curve-header">
                        <span class="curve-title">Luminance → Luminance</span>
                    </div>
                    <canvas id="lumVsLumCanvas" class="curve-canvas" width="380" height="100"></canvas>
                    <div class="point-indicator" id="lumVsLumInfo">Click to add points</div>
                </div>
                
                <div class="section-header">Channel Crosstalk Matrix</div>
                <div style="font-size: 11px; color: #888; margin-bottom: 10px;">How each channel affects others (film dye interaction)</div>
                <div class="crosstalk-matrix">
                    <div></div>
                    <div class="matrix-label">R</div>
                    <div class="matrix-label">G</div>
                    <div class="matrix-label">B</div>
                    
                    <div class="matrix-label">R</div>
                    <input type="number" class="matrix-input" id="m00" step="0.01" value="1.00">
                    <input type="number" class="matrix-input" id="m01" step="0.01" value="0.00">
                    <input type="number" class="matrix-input" id="m02" step="0.01" value="0.00">
                    
                    <div class="matrix-label">G</div>
                    <input type="number" class="matrix-input" id="m10" step="0.01" value="0.00">
                    <input type="number" class="matrix-input" id="m11" step="0.01" value="1.00">
                    <input type="number" class="matrix-input" id="m12" step="0.01" value="0.00">
                    
                    <div class="matrix-label">B</div>
                    <input type="number" class="matrix-input" id="m20" step="0.01" value="0.00">
                    <input type="number" class="matrix-input" id="m21" step="0.01" value="0.00">
                    <input type="number" class="matrix-input" id="m22" step="0.01" value="1.00">
                </div>
                
                <div class="global-controls">
                    <h3 style="margin-bottom: 15px; font-size: 16px;">Global Adjustments</h3>
                    
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Exposure</span>
                            <span id="exposureValue">1.0</span>
                        </div>
                        <input type="range" class="slider" id="exposureSlider" min="0.5" max="2" step="0.01" value="1">
                    </div>
                    
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Saturation</span>
                            <span id="saturationValue">1.0</span>
                        </div>
                        <input type="range" class="slider" id="saturationSlider" min="0" max="2" step="0.01" value="1">
                    </div>
                    
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Contrast</span>
                            <span id="contrastValue">1.0</span>
                        </div>
                        <input type="range" class="slider" id="contrastSlider" min="0.5" max="2" step="0.01" value="1">
                    </div>
                    
                    <button class="reset-btn" onclick="resetAll()">Reset All</button>
                </div>
            </div>
            
            <!-- Visualization Panel -->
            <div class="visualization-panel">
                <h3 style="margin-bottom: 15px; font-size: 16px;">Color Response Visualization</h3>
                <div class="test-images">
                    <div class="image-pair">
                        <div class="image-label">HUE vs SATURATION</div>
                        <div class="image-container">
                            <div>
                                <canvas id="hueSatOriginal" width="256" height="256"></canvas>
                                <div class="image-subtitle">Original</div>
                            </div>
                            <div>
                                <canvas id="hueSatProcessed" width="256" height="256"></canvas>
                                <div class="image-subtitle">Processed</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="image-pair">
                        <div class="image-label">HUE vs LUMINANCE</div>
                        <div class="image-container">
                            <div>
                                <canvas id="hueLumOriginal" width="256" height="256"></canvas>
                                <div class="image-subtitle">Original</div>
                            </div>
                            <div>
                                <canvas id="hueLumProcessed" width="256" height="256"></canvas>
                                <div class="image-subtitle">Processed</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="image-pair">
                        <div class="image-label">MACBETH COLORCHECKER</div>
                        <div class="image-container">
                            <div>
                                <canvas id="macbethOriginal" width="256" height="170"></canvas>
                                <div class="image-subtitle">Original</div>
                            </div>
                            <div>
                                <canvas id="macbethProcessed" width="256" height="170"></canvas>
                                <div class="image-subtitle">Processed</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="image-pair">
                        <div class="image-label">SATURATION GRADIENT</div>
                        <div class="image-container">
                            <div>
                                <canvas id="satGradOriginal" width="256" height="256"></canvas>
                                <div class="image-subtitle">Original</div>
                            </div>
                            <div>
                                <canvas id="satGradProcessed" width="256" height="256"></canvas>
                                <div class="image-subtitle">Processed</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Vectorscope Panel -->
            <div class="scope-panel">
                <div class="scope-label">VECTORSCOPE</div>
                <div class="vectorscope-container">
                    <canvas id="vectorscope" class="vectorscope" width="260" height="260"></canvas>
                </div>
                <div class="scope-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff0000;"></div>
                        <span>Red (0°)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffff00;"></div>
                        <span>Yellow (60°)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #00ff00;"></div>
                        <span>Green (120°)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #00ffff;"></div>
                        <span>Cyan (180°)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #0000ff;"></div>
                        <span>Blue (240°)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff00ff;"></div>
                        <span>Magenta (300°)</span>
                    </div>
                </div>
                <div style="margin-top: 15px; font-size: 11px; color: #888; text-align: center;">
                    Center = no color, edge = max saturation<br>
                    Angle = hue, distance = saturation
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================================================
        // COLOR MATH
        // ========================================================================
        
        function rgbToHsv(r, g, b) {
            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            const delta = max - min;
            
            let h = 0;
            if (delta !== 0) {
                if (max === r) h = 60 * (((g - b) / delta) % 6);
                else if (max === g) h = 60 * (((b - r) / delta) + 2);
                else h = 60 * (((r - g) / delta) + 4);
            }
            if (h < 0) h += 360;
            
            const s = max === 0 ? 0 : delta / max;
            const v = max;
            
            return [h, s, v];
        }
        
        function hsvToRgb(h, s, v) {
            const c = v * s;
            const x = c * (1 - Math.abs((h / 60) % 2 - 1));
            const m = v - c;
            
            let r, g, b;
            if (h < 60) [r, g, b] = [c, x, 0];
            else if (h < 120) [r, g, b] = [x, c, 0];
            else if (h < 180) [r, g, b] = [0, c, x];
            else if (h < 240) [r, g, b] = [0, x, c];
            else if (h < 300) [r, g, b] = [x, 0, c];
            else [r, g, b] = [c, 0, x];
            
            return [r + m, g + m, b + m];
        }
        
        function cubicSplineInterpolate(x, points) {
            points.sort((a, b) => a[0] - b[0]);
            
            if (x <= points[0][0]) return points[0][1];
            if (x >= points[points.length - 1][0]) return points[points.length - 1][1];
            
            for (let i = 0; i < points.length - 1; i++) {
                const [x1, y1] = points[i];
                const [x2, y2] = points[i + 1];
                
                if (x >= x1 && x <= x2) {
                    const t = (x - x1) / (x2 - x1);
                    
                    const [x0, y0] = i > 0 ? points[i - 1] : [x1, y1];
                    const [x3, y3] = i < points.length - 2 ? points[i + 2] : [x2, y2];
                    
                    const m1 = i > 0 ? (y2 - y0) / (x2 - x0) : (y2 - y1) / (x2 - x1);
                    const m2 = i < points.length - 2 ? (y3 - y1) / (x3 - x1) : (y2 - y1) / (x2 - x1);
                    
                    const t2 = t * t;
                    const t3 = t2 * t;
                    const h00 = 2*t3 - 3*t2 + 1;
                    const h10 = t3 - 2*t2 + t;
                    const h01 = -2*t3 + 3*t2;
                    const h11 = t3 - t2;
                    
                    return h00*y1 + h10*(x2-x1)*m1 + h01*y2 + h11*(x2-x1)*m2;
                }
            }
            return points[points.length - 1][1];
        }
        
        // ========================================================================
        // TRANSFORM STATE
        // ========================================================================
        
        const transform = {
            hueVsHue: [[0, 0], [360, 0]],
            hueVsSat: [[0, 1], [360, 1]],
            hueVsLum: [[0, 0], [360, 0]],
            satVsSat: [[0, 0], [1, 1]],
            lumVsSat: [[0, 1], [1, 1]],
            lumVsLum: [[0, 0], [1, 1]],
            crosstalk: [
                [1, 0, 0],
                [0, 1, 0],
                [0, 0, 1]
            ],
            globalExposure: 1.0,
            globalSaturation: 1.0,
            globalContrast: 1.0
        };
        
        function getCrosstalkMatrix() {
            return [
                [parseFloat(document.getElementById('m00').value), parseFloat(document.getElementById('m01').value), parseFloat(document.getElementById('m02').value)],
                [parseFloat(document.getElementById('m10').value), parseFloat(document.getElementById('m11').value), parseFloat(document.getElementById('m12').value)],
                [parseFloat(document.getElementById('m20').value), parseFloat(document.getElementById('m21').value), parseFloat(document.getElementById('m22').value)]
            ];
        }
        
        function transformColor(r, g, b) {
            // Convert to HSV
            let [h, s, v] = rgbToHsv(r, g, b);
            
            // Apply hue shift
            const hueShift = cubicSplineInterpolate(h, transform.hueVsHue);
            h = (h + hueShift) % 360;
            if (h < 0) h += 360;
            
            // Apply hue-dependent saturation
            const satMult = cubicSplineInterpolate(h, transform.hueVsSat);
            s = Math.max(0, Math.min(1, s * satMult));
            
            // Apply hue-dependent luminance
            const lumOffset = cubicSplineInterpolate(h, transform.hueVsLum);
            v = Math.max(0, Math.min(1, v + lumOffset));
            
            // Apply saturation-dependent saturation (non-linear)
            const satCurve = cubicSplineInterpolate(s, transform.satVsSat);
            s = Math.max(0, Math.min(1, satCurve));
            
            // Apply luminance-dependent saturation
            const lumSatMult = cubicSplineInterpolate(v, transform.lumVsSat);
            s = Math.max(0, Math.min(1, s * lumSatMult));
            
            // Apply global saturation
            s = Math.max(0, Math.min(1, s * transform.globalSaturation));
            
            // Apply tone curve
            v = cubicSplineInterpolate(v, transform.lumVsLum);
            
            // Apply contrast around midpoint
            v = 0.5 + (v - 0.5) * transform.globalContrast;
            
            // Apply exposure
            v = Math.max(0, Math.min(1, v * transform.globalExposure));
            
            // Convert back to RGB
            let [rOut, gOut, bOut] = hsvToRgb(h, s, v);
            
            // Apply channel crosstalk
            const matrix = getCrosstalkMatrix();
            const rFinal = matrix[0][0] * rOut + matrix[0][1] * gOut + matrix[0][2] * bOut;
            const gFinal = matrix[1][0] * rOut + matrix[1][1] * gOut + matrix[1][2] * bOut;
            const bFinal = matrix[2][0] * rOut + matrix[2][1] * gOut + matrix[2][2] * bOut;
            
            return [
                Math.max(0, Math.min(1, rFinal)),
                Math.max(0, Math.min(1, gFinal)),
                Math.max(0, Math.min(1, bFinal))
            ];
        }
        
        // ========================================================================
        // CURVE EDITOR
        // ========================================================================
        
        class CurveEditor {
            constructor(canvasId, curveName, infoId, xRange, yRange, yLabel) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.curveName = curveName;
                this.infoEl = document.getElementById(infoId);
                this.xRange = xRange;
                this.yRange = yRange;
                this.yLabel = yLabel;
                this.draggingPoint = null;
                
                this.canvas.addEventListener('mousedown', this.onMouseDown.bind(this));
                this.canvas.addEventListener('mousemove', this.onMouseMove.bind(this));
                this.canvas.addEventListener('mouseup', this.onMouseUp.bind(this));
                this.canvas.addEventListener('mouseleave', this.onMouseUp.bind(this));
                
                this.draw();
            }
            
            canvasToValue(cx, cy) {
                const x = (cx / this.canvas.width) * this.xRange[1];
                const y = this.yRange[1] - (cy / this.canvas.height) * (this.yRange[1] - this.yRange[0]);
                return [x, y];
            }
            
            valueToCanvas(x, y) {
                const cx = (x / this.xRange[1]) * this.canvas.width;
                const cy = this.canvas.height - ((y - this.yRange[0]) / (this.yRange[1] - this.yRange[0])) * this.canvas.height;
                return [cx, cy];
            }
            
            onMouseDown(e) {
                const rect = this.canvas.getBoundingClientRect();
                const mx = e.clientX - rect.left;
                const my = e.clientY - rect.top;
                
                const points = transform[this.curveName];
                
                // Check if clicking near existing point
                for (let i = 0; i < points.length; i++) {
                    const [cx, cy] = this.valueToCanvas(points[i][0], points[i][1]);
                    const dist = Math.sqrt((mx - cx)**2 + (my - cy)**2);
                    if (dist < 8) {
                        this.draggingPoint = i;
                        return;
                    }
                }
                
                // Add new point
                const [x, y] = this.canvasToValue(mx, my);
                points.push([x, y]);
                points.sort((a, b) => a[0] - b[0]);
                this.draggingPoint = points.findIndex(p => p[0] === x && p[1] === y);
                
                this.draw();
                updateVisualization();
            }
            
            onMouseMove(e) {
                const rect = this.canvas.getBoundingClientRect();
                const mx = e.clientX - rect.left;
                const my = e.clientY - rect.top;
                
                if (this.draggingPoint !== null) {
                    const [x, y] = this.canvasToValue(mx, my);
                    const points = transform[this.curveName];
                    
                    // Clamp values
                    const clampedX = Math.max(this.xRange[0], Math.min(this.xRange[1], x));
                    const clampedY = Math.max(this.yRange[0], Math.min(this.yRange[1], y));
                    
                    points[this.draggingPoint] = [clampedX, clampedY];
                    points.sort((a, b) => a[0] - b[0]);
                    
                    this.draw();
                    updateVisualization();
                }
                
                // Show info
                const [x, y] = this.canvasToValue(mx, my);
                this.infoEl.textContent = `x: ${x.toFixed(1)}, y: ${y.toFixed(2)}`;
            }
            
            onMouseUp(e) {
                this.draggingPoint = null;
            }
            
            draw() {
                const ctx = this.ctx;
                const w = this.canvas.width;
                const h = this.canvas.height;
                
                // Clear
                ctx.fillStyle = '#1a1a1a';
                ctx.fillRect(0, 0, w, h);
                
                // Grid
                ctx.strokeStyle = '#2a2a2a';
                ctx.lineWidth = 1;
                for (let i = 0; i <= 4; i++) {
                    const y = (i / 4) * h;
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(w, y);
                    ctx.stroke();
                }
                
                // Zero line or unity line
                if (this.yRange[0] < 0 && this.yRange[1] > 0) {
                    const [_, cy] = this.valueToCanvas(0, 0);
                    ctx.strokeStyle = '#444';
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(0, cy);
                    ctx.lineTo(w, cy);
                    ctx.stroke();
                    ctx.setLineDash([]);
                } else if (this.yRange[0] === 0 && this.yRange[1] === 1) {
                    // Diagonal unity line for 0-1 curves
                    ctx.strokeStyle = '#333';
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(0, h);
                    ctx.lineTo(w, 0);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
                
                // Draw curve
                const points = transform[this.curveName];
                ctx.strokeStyle = '#0088ff';
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                for (let px = 0; px < w; px++) {
                    const [x, _] = this.canvasToValue(px, 0);
                    const y = cubicSplineInterpolate(x, points);
                    const [cx, cy] = this.valueToCanvas(x, y);
                    
                    if (px === 0) ctx.moveTo(cx, cy);
                    else ctx.lineTo(cx, cy);
                }
                ctx.stroke();
                
                // Draw points
                ctx.fillStyle = '#fff';
                ctx.strokeStyle = '#0088ff';
                ctx.lineWidth = 2;
                for (const [x, y] of points) {
                    const [cx, cy] = this.valueToCanvas(x, y);
                    ctx.beginPath();
                    ctx.arc(cx, cy, 5, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                }
            }
        }
        
        // Initialize curve editors
        const editors = {
            hueVsHue: new CurveEditor('hueVsHueCanvas', 'hueVsHue', 'hueVsHueInfo', [0, 360], [-30, 30], 'Shift'),
            hueVsSat: new CurveEditor('hueVsSatCanvas', 'hueVsSat', 'hueVsSatInfo', [0, 360], [0, 2], 'Mult'),
            hueVsLum: new CurveEditor('hueVsLumCanvas', 'hueVsLum', 'hueVsLumInfo', [0, 360], [-0.2, 0.2], 'Offset'),
            satVsSat: new CurveEditor('satVsSatCanvas', 'satVsSat', 'satVsSatInfo', [0, 1], [0, 1], 'Out'),
            lumVsSat: new CurveEditor('lumVsSatCanvas', 'lumVsSat', 'lumVsSatInfo', [0, 1], [0, 2], 'Mult'),
            lumVsLum: new CurveEditor('lumVsLumCanvas', 'lumVsLum', 'lumVsLumInfo', [0, 1], [0, 1], 'Out')
        };
        
        // ========================================================================
        // TEST IMAGE GENERATION
        // ========================================================================
        
        function generateHueSatChart(width, height) {
            const data = new Uint8ClampedArray(width * height * 4);
            for (let y = 0; y < height; y++) {
                const sat = 1 - (y / height);
                for (let x = 0; x < width; x++) {
                    const hue = (x / width) * 360;
                    const [r, g, b] = hsvToRgb(hue, sat, 0.7);
                    const idx = (y * width + x) * 4;
                    data[idx] = r * 255;
                    data[idx + 1] = g * 255;
                    data[idx + 2] = b * 255;
                    data[idx + 3] = 255;
                }
            }
            return new ImageData(data, width, height);
        }
        
        function generateHueLumChart(width, height) {
            const data = new Uint8ClampedArray(width * height * 4);
            for (let y = 0; y < height; y++) {
                const lum = 1 - (y / height);
                for (let x = 0; x < width; x++) {
                    const hue = (x / width) * 360;
                    const [r, g, b] = hsvToRgb(hue, 0.8, lum);
                    const idx = (y * width + x) * 4;
                    data[idx] = r * 255;
                    data[idx + 1] = g * 255;
                    data[idx + 2] = b * 255;
                    data[idx + 3] = 255;
                }
            }
            return new ImageData(data, width, height);
        }
        
        function generateMacbethChart(width, height) {
            const colors = [
                [0.44, 0.31, 0.24], [0.77, 0.57, 0.48], [0.36, 0.45, 0.60],
                [0.33, 0.42, 0.27], [0.54, 0.51, 0.73], [0.47, 0.75, 0.67],
                [0.93, 0.60, 0.12], [0.36, 0.40, 0.70], [0.76, 0.37, 0.42],
                [0.36, 0.22, 0.43], [0.64, 0.83, 0.36], [0.98, 0.73, 0.20],
                [0.27, 0.29, 0.75], [0.41, 0.71, 0.43], [0.75, 0.24, 0.26],
                [0.96, 0.92, 0.20], [0.82, 0.38, 0.70], [0.17, 0.62, 0.73],
                [0.95, 0.95, 0.95], [0.78, 0.78, 0.78], [0.63, 0.63, 0.63],
                [0.47, 0.47, 0.47], [0.31, 0.31, 0.31], [0.12, 0.12, 0.12]
            ];
            
            const data = new Uint8ClampedArray(width * height * 4);
            const patchW = width / 6;
            const patchH = height / 4;
            
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const col = Math.floor(x / patchW);
                    const row = Math.floor(y / patchH);
                    const colorIdx = row * 6 + col;
                    
                    if (colorIdx < colors.length) {
                        const [r, g, b] = colors[colorIdx];
                        const idx = (y * width + x) * 4;
                        data[idx] = r * 255;
                        data[idx + 1] = g * 255;
                        data[idx + 2] = b * 255;
                        data[idx + 3] = 255;
                    }
                }
            }
            return new ImageData(data, width, height);
        }
        
        function generateSatGradient(width, height) {
            const data = new Uint8ClampedArray(width * height * 4);
            for (let y = 0; y < height; y++) {
                const lum = 1 - (y / height);
                for (let x = 0; x < width; x++) {
                    const sat = x / width;
                    const [r, g, b] = hsvToRgb(30, sat, lum);
                    const idx = (y * width + x) * 4;
                    data[idx] = r * 255;
                    data[idx + 1] = g * 255;
                    data[idx + 2] = b * 255;
                    data[idx + 3] = 255;
                }
            }
            return new ImageData(data, width, height);
        }
        
        function processImageData(imageData) {
            const processed = new ImageData(
                new Uint8ClampedArray(imageData.data),
                imageData.width,
                imageData.height
            );
            
            for (let i = 0; i < processed.data.length; i += 4) {
                const r = processed.data[i] / 255;
                const g = processed.data[i + 1] / 255;
                const b = processed.data[i + 2] / 255;
                
                const [rOut, gOut, bOut] = transformColor(r, g, b);
                
                processed.data[i] = Math.max(0, Math.min(255, rOut * 255));
                processed.data[i + 1] = Math.max(0, Math.min(255, gOut * 255));
                processed.data[i + 2] = Math.max(0, Math.min(255, bOut * 255));
            }
            
            return processed;
        }
        
        // ========================================================================
        // VECTORSCOPE
        // ========================================================================
        
        function drawVectorscope() {
            const canvas = document.getElementById('vectorscope');
            const ctx = canvas.getContext('2d');
            const w = canvas.width;
            const h = canvas.height;
            const cx = w / 2;
            const cy = h / 2;
            const radius = Math.min(w, h) / 2 - 20;
            
            // Clear
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(0, 0, w, h);
            
            // Draw graticule circles
            ctx.strokeStyle = '#2a2a2a';
            ctx.lineWidth = 1;
            for (let i = 1; i <= 4; i++) {
                ctx.beginPath();
                ctx.arc(cx, cy, radius * i / 4, 0, Math.PI * 2);
                ctx.stroke();
            }
            
            // Draw hue lines
            const hues = [0, 60, 120, 180, 240, 300];
            const hueColors = ['#ff4444', '#ffff44', '#44ff44', '#44ffff', '#4444ff', '#ff44ff'];
            const hueLabels = ['R', 'Yl', 'G', 'Cy', 'B', 'Mg'];
            
            ctx.lineWidth = 1;
            for (let i = 0; i < hues.length; i++) {
                const angle = (hues[i] - 90) * Math.PI / 180;
                const x = cx + Math.cos(angle) * radius;
                const y = cy + Math.sin(angle) * radius;
                
                // Line
                ctx.strokeStyle = '#333';
                ctx.beginPath();
                ctx.moveTo(cx, cy);
                ctx.lineTo(x, y);
                ctx.stroke();
                
                // Target box
                ctx.strokeStyle = hueColors[i];
                ctx.lineWidth = 2;
                const boxSize = 8;
                ctx.strokeRect(x - boxSize/2, y - boxSize/2, boxSize, boxSize);
                
                // Label
                ctx.fillStyle = '#aaa';
                ctx.font = '11px monospace';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const labelDist = radius + 15;
                const lx = cx + Math.cos(angle) * labelDist;
                const ly = cy + Math.sin(angle) * labelDist;
                ctx.fillText(hueLabels[i], lx, ly);
            }
            
            // Sample and plot colors from processed image
            const processedImg = document.getElementById('hueSatProcessed').getContext('2d').getImageData(0, 0, 256, 256);
            
            ctx.lineWidth = 1;
            
            // Plot sample points
            for (let y = 0; y < 256; y += 4) {
                for (let x = 0; x < 256; x += 4) {
                    const idx = (y * 256 + x) * 4;
                    const r = processedImg.data[idx] / 255;
                    const g = processedImg.data[idx + 1] / 255;
                    const b = processedImg.data[idx + 2] / 255;
                    
                    const [h, s, v] = rgbToHsv(r, g, b);
                    
                    // Only plot if saturation is significant
                    if (s > 0.1 && v > 0.1) {
                        const angle = (h - 90) * Math.PI / 180;
                        const dist = s * radius;
                        const px = cx + Math.cos(angle) * dist;
                        const py = cy + Math.sin(angle) * dist;
                        
                        // Draw point with actual color
                        ctx.fillStyle = `rgba(${r*255}, ${g*255}, ${b*255}, 0.3)`;
                        ctx.fillRect(px - 1, py - 1, 2, 2);
                    }
                }
            }
            
            // Draw center point
            ctx.fillStyle = '#666';
            ctx.beginPath();
            ctx.arc(cx, cy, 3, 0, Math.PI * 2);
            ctx.fill();
            
            // Plot the 6 reference colors after transformation
            ctx.lineWidth = 2;
            for (let i = 0; i < hues.length; i++) {
                const [r, g, b] = hsvToRgb(hues[i], 1, 0.8);
                const [rOut, gOut, bOut] = transformColor(r, g, b);
                const [hOut, sOut, vOut] = rgbToHsv(rOut, gOut, bOut);
                
                const angle = (hOut - 90) * Math.PI / 180;
                const dist = sOut * radius;
                const px = cx + Math.cos(angle) * dist;
                const py = cy + Math.sin(angle) * dist;
                
                // Draw transformed color point
                ctx.fillStyle = `rgb(${rOut*255}, ${gOut*255}, ${bOut*255})`;
                ctx.strokeStyle = '#fff';
                ctx.beginPath();
                ctx.arc(px, py, 5, 0, Math.PI * 2);
                ctx.fill();
                ctx.stroke();
            }
        }
        
        // ========================================================================
        // VISUALIZATION UPDATE
        // ========================================================================
        
        let originalImages = {};
        
        function initializeOriginalImages() {
            originalImages.hueSat = generateHueSatChart(256, 256);
            originalImages.hueLum = generateHueLumChart(256, 256);
            originalImages.macbeth = generateMacbethChart(256, 170);
            originalImages.satGrad = generateSatGradient(256, 256);
            
            // Draw originals
            document.getElementById('hueSatOriginal').getContext('2d').putImageData(originalImages.hueSat, 0, 0);
            document.getElementById('hueLumOriginal').getContext('2d').putImageData(originalImages.hueLum, 0, 0);
            document.getElementById('macbethOriginal').getContext('2d').putImageData(originalImages.macbeth, 0, 0);
            document.getElementById('satGradOriginal').getContext('2d').putImageData(originalImages.satGrad, 0, 0);
        }
        
        function updateVisualization() {
            // Process and display
            const hueSatProcessed = processImageData(originalImages.hueSat);
            const hueLumProcessed = processImageData(originalImages.hueLum);
            const macbethProcessed = processImageData(originalImages.macbeth);
            const satGradProcessed = processImageData(originalImages.satGrad);
            
            document.getElementById('hueSatProcessed').getContext('2d').putImageData(hueSatProcessed, 0, 0);
            document.getElementById('hueLumProcessed').getContext('2d').putImageData(hueLumProcessed, 0, 0);
            document.getElementById('macbethProcessed').getContext('2d').putImageData(macbethProcessed, 0, 0);
            document.getElementById('satGradProcessed').getContext('2d').putImageData(satGradProcessed, 0, 0);
            
            // Update vectorscope
            drawVectorscope();
        }
        
        // ========================================================================
        // PRESETS
        // ========================================================================
        
        function setCrosstalkMatrix(matrix) {
            document.getElementById('m00').value = matrix[0][0].toFixed(3);
            document.getElementById('m01').value = matrix[0][1].toFixed(3);
            document.getElementById('m02').value = matrix[0][2].toFixed(3);
            document.getElementById('m10').value = matrix[1][0].toFixed(3);
            document.getElementById('m11').value = matrix[1][1].toFixed(3);
            document.getElementById('m12').value = matrix[1][2].toFixed(3);
            document.getElementById('m20').value = matrix[2][0].toFixed(3);
            document.getElementById('m21').value = matrix[2][1].toFixed(3);
            document.getElementById('m22').value = matrix[2][2].toFixed(3);
        }
        
        function loadPreset(preset) {
            // Update active button
            document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (preset === 'neutral') {
                transform.hueVsHue = [[0, 0], [360, 0]];
                transform.hueVsSat = [[0, 1], [360, 1]];
                transform.hueVsLum = [[0, 0], [360, 0]];
                transform.satVsSat = [[0, 0], [1, 1]];
                transform.lumVsSat = [[0, 1], [1, 1]];
                transform.lumVsLum = [[0, 0], [1, 1]];
                transform.globalExposure = 1.0;
                transform.globalSaturation = 1.0;
                transform.globalContrast = 1.0;
                setCrosstalkMatrix([[1, 0, 0], [0, 1, 0], [0, 0, 1]]);
            } else if (preset === 'velvia') {
                transform.hueVsHue = [[0, 5], [60, 10], [120, -5], [180, 0], [240, 5], [300, 0], [360, 5]];
                transform.hueVsSat = [[0, 1.2], [60, 1.4], [120, 1.5], [180, 1.3], [240, 1.4], [300, 1.1], [360, 1.2]];
                transform.hueVsLum = [[0, 0], [60, 0.05], [120, 0], [180, -0.02], [240, -0.03], [300, 0], [360, 0]];
                transform.satVsSat = [[0, 0], [0.3, 0.35], [0.6, 0.7], [0.9, 0.95], [1, 1]];
                transform.lumVsSat = [[0, 0.7], [0.2, 1.0], [0.5, 1.2], [0.8, 1.1], [1, 0.9]];
                transform.lumVsLum = [[0, 0], [0.1, 0.15], [0.3, 0.35], [0.5, 0.5], [0.7, 0.68], [0.9, 0.88], [1, 1]];
                transform.globalSaturation = 1.2;
                transform.globalContrast = 1.15;
                transform.globalExposure = 1.0;
                setCrosstalkMatrix([[1, -0.02, -0.01], [-0.01, 1, -0.02], [-0.02, -0.02, 1]]);
            } else if (preset === 'portra') {
                transform.hueVsHue = [[0, -3], [30, 5], [60, 5], [120, 0], [180, -5], [240, -5], [300, 0], [360, -3]];
                transform.hueVsSat = [[0, 0.9], [30, 1.0], [60, 0.95], [120, 0.85], [180, 0.9], [240, 0.85], [300, 0.9], [360, 0.9]];
                transform.hueVsLum = [[0, 0], [30, 0.03], [60, 0.02], [120, 0], [180, 0], [240, 0], [300, 0], [360, 0]];
                transform.satVsSat = [[0, 0], [0.4, 0.35], [0.7, 0.65], [1, 0.9]];
                transform.lumVsSat = [[0, 0.6], [0.2, 0.85], [0.5, 1.0], [0.8, 0.95], [1, 0.8]];
                transform.lumVsLum = [[0, 0.02], [0.1, 0.12], [0.3, 0.32], [0.5, 0.5], [0.7, 0.7], [0.9, 0.92], [1, 0.98]];
                transform.globalSaturation = 0.9;
                transform.globalContrast = 0.95;
                transform.globalExposure = 1.0;
                setCrosstalkMatrix([[1, -0.05, -0.03], [-0.03, 1, -0.05], [-0.04, -0.04, 1]]);
            } else if (preset === 'cinestill') {
                transform.hueVsHue = [[0, 10], [60, 10], [120, -5], [180, -10], [240, -8], [300, 5], [360, 10]];
                transform.hueVsSat = [[0, 1.2], [60, 1.1], [120, 0.95], [180, 1.1], [240, 1.3], [300, 1.15], [360, 1.2]];
                transform.hueVsLum = [[0, 0.05], [60, 0.03], [120, 0], [180, -0.05], [240, -0.03], [300, 0], [360, 0.05]];
                transform.satVsSat = [[0, 0], [0.25, 0.27], [0.5, 0.55], [0.75, 0.78], [1, 1]];
                transform.lumVsSat = [[0, 0.8], [0.2, 1.0], [0.5, 1.1], [0.8, 1.2], [1, 1.3]];
                transform.lumVsLum = [[0, 0], [0.15, 0.18], [0.35, 0.4], [0.5, 0.52], [0.7, 0.73], [0.85, 0.9], [1, 1]];
                transform.globalSaturation = 1.05;
                transform.globalContrast = 1.1;
                transform.globalExposure = 1.0;
                setCrosstalkMatrix([[1, -0.03, -0.02], [-0.02, 1, -0.03], [-0.03, -0.03, 1]]);
            } else if (preset === 'teal_orange') {
                transform.hueVsHue = [[0, 15], [30, 20], [60, 10], [120, 0], [180, -15], [200, -20], [240, -10], [300, 5], [360, 15]];
                transform.hueVsSat = [[0, 1.3], [30, 1.4], [60, 1.2], [120, 0.9], [180, 1.4], [200, 1.5], [240, 1.2], [300, 1.0], [360, 1.3]];
                transform.hueVsLum = [[0, 0.02], [60, 0.03], [120, -0.02], [180, 0], [240, -0.03], [300, 0], [360, 0.02]];
                transform.satVsSat = [[0, 0], [0.3, 0.35], [0.6, 0.68], [0.9, 0.92], [1, 1]];
                transform.lumVsSat = [[0, 0.7], [0.3, 1.1], [0.6, 1.2], [0.9, 0.9], [1, 0.7]];
                transform.lumVsLum = [[0, 0.05], [0.2, 0.22], [0.5, 0.5], [0.8, 0.82], [1, 0.95]];
                transform.globalSaturation = 1.2;
                transform.globalContrast = 1.15;
                transform.globalExposure = 1.0;
                setCrosstalkMatrix([[1, -0.01, -0.01], [-0.01, 1, -0.01], [-0.01, -0.01, 1]]);
            } else if (preset === 'agfa') {
                transform.hueVsHue = [[0, 8], [60, 12], [120, 5], [180, -5], [240, -3], [300, 5], [360, 8]];
                transform.hueVsSat = [[0, 1.1], [60, 1.25], [120, 1.2], [180, 1.0], [240, 0.95], [300, 1.05], [360, 1.1]];
                transform.hueVsLum = [[0, 0.02], [60, 0.04], [120, 0.01], [180, 0], [240, -0.01], [300, 0], [360, 0.02]];
                transform.satVsSat = [[0, 0], [0.4, 0.43], [0.7, 0.75], [1, 1]];
                transform.lumVsSat = [[0, 0.75], [0.3, 1.05], [0.6, 1.1], [1, 0.9]];
                transform.lumVsLum = [[0, 0], [0.25, 0.25], [0.5, 0.5], [0.75, 0.75], [1, 1]];
                transform.globalSaturation = 1.1;
                transform.globalContrast = 1.0;
                transform.globalExposure = 1.0;
                setCrosstalkMatrix([[1, -0.04, -0.02], [-0.02, 1, -0.04], [-0.03, -0.03, 1]]);
            }
            
            // Update sliders
            document.getElementById('exposureSlider').value = transform.globalExposure;
            document.getElementById('exposureValue').textContent = transform.globalExposure.toFixed(2);
            document.getElementById('saturationSlider').value = transform.globalSaturation;
            document.getElementById('saturationValue').textContent = transform.globalSaturation.toFixed(2);
            document.getElementById('contrastSlider').value = transform.globalContrast;
            document.getElementById('contrastValue').textContent = transform.globalContrast.toFixed(2);
            
            // Redraw curves and update visualization
            Object.values(editors).forEach(editor => editor.draw());
            updateVisualization();
        }
        
        function resetAll() {
            loadPreset('neutral');
            document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.preset-btn').classList.add('active');
        }
        
        // ========================================================================
        // GLOBAL CONTROLS
        // ========================================================================
        
        document.getElementById('exposureSlider').addEventListener('input', (e) => {
            transform.globalExposure = parseFloat(e.target.value);
            document.getElementById('exposureValue').textContent = transform.globalExposure.toFixed(2);
            updateVisualization();
        });
        
        document.getElementById('saturationSlider').addEventListener('input', (e) => {
            transform.globalSaturation = parseFloat(e.target.value);
            document.getElementById('saturationValue').textContent = transform.globalSaturation.toFixed(2);
            updateVisualization();
        });
        
        document.getElementById('contrastSlider').addEventListener('input', (e) => {
            transform.globalContrast = parseFloat(e.target.value);
            document.getElementById('contrastValue').textContent = transform.globalContrast.toFixed(2);
            updateVisualization();
        });
        
        // Matrix input listeners
        for (let i = 0; i < 3; i++) {
            for (let j = 0; j < 3; j++) {
                document.getElementById(`m${i}${j}`).addEventListener('input', () => {
                    updateVisualization();
                });
            }
        }
        
        // ========================================================================
        // INITIALIZE
        // ========================================================================
        
        initializeOriginalImages();
        updateVisualization();
        document.querySelector('.preset-btn').classList.add('active');
    </script>
</body>
</html>